<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Flink1.15 CheckPoint restore源码分析" /><meta property="og:locale" content="en" /><meta name="description" content="当所有task成功后，执行completePendingCheckpoint()操作" /><meta property="og:description" content="当所有task成功后，执行completePendingCheckpoint()操作" /><link rel="canonical" href="/posts/ckp_restore/" /><meta property="og:url" content="/posts/ckp_restore/" /><meta property="og:site_name" content="2pc" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-26T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Flink1.15 CheckPoint restore源码分析" /><meta name="twitter:site" content="@2pc" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-17T12:13:57+00:00","datePublished":"2022-07-26T00:00:00+00:00","description":"当所有task成功后，执行completePendingCheckpoint()操作","headline":"Flink1.15 CheckPoint restore源码分析","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/ckp_restore/"},"url":"/posts/ckp_restore/"}</script><title>Flink1.15 CheckPoint restore源码分析 | 2pc</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="2pc"><meta name="application-name" content="2pc"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">2pc</a></div><div class="site-subtitle font-italic">A text-focused Jekyll theme</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/2pc" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/2pc" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['2pcgithub','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Flink1.15 CheckPoint restore源码分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Flink1.15 CheckPoint restore源码分析</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658793600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 26, 2022 </em> </span> <span> Updated <em class="" data-ts="1666008837" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 17, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/2pc">2pc</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1298 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>当所有task成功后，执行completePendingCheckpoint()操作</p><ol><li>将PendingCheckpoint 转成CompletedCheckpoint，并将CheckpointMetadata持久化<li>更新completedCheckpointStore<li><p>通知其他算子ack,执行commit ``` //CheckpointCoordinator private void completePendingCheckpoint(PendingCheckpoint pendingCheckpoint) throws CheckpointException { final long checkpointId = pendingCheckpoint.getCheckpointID(); final CompletedCheckpoint completedCheckpoint; final CompletedCheckpoint lastSubsumed; final CheckpointProperties props = pendingCheckpoint.getProps();</p><p>completedCheckpointStore.getSharedStateRegistry().checkpointCompleted(checkpointId);</p><p>try { //将PendingCheckpoint 转成CompletedCheckpoint completedCheckpoint = finalizeCheckpoint(pendingCheckpoint);</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre> // the pending checkpoint must be discarded after the finalization
 Preconditions.checkState(pendingCheckpoint.isDisposed() &amp;&amp; completedCheckpoint != null);
 //更新到completedCheckpointStore,
 //ZooKeeperStateHandleStore
 if (!props.isSavepoint()) {
     lastSubsumed =
     addCompletedCheckpointToStoreAndSubsumeOldest(
         checkpointId,
         completedCheckpoint,
         pendingCheckpoint.getCheckpointPlan().getTasksToCommitTo());
 } else {
     lastSubsumed = null;
 }

 reportCompletedCheckpoint(completedCheckpoint);  } finally {
 pendingCheckpoints.remove(checkpointId);
 //异步ack
 scheduleTriggerRequest();  }  //ack--&gt;sendAcknowledgeMessages--&gt;notifyCheckpointComplete  cleanupAfterCompletedCheckpoint(
 pendingCheckpoint, checkpointId, completedCheckpoint, lastSubsumed, props); }
</pre></table></code></div></div></ol><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>finalizeCheckpoint主要将PendingCheckpoint 转成CompletedCheckpoint，并持久化ckp元数据信息
</pre></table></code></div></div><p>public CompletedCheckpoint finalizeCheckpoint( CheckpointsCleaner checkpointsCleaner, Runnable postCleanup, Executor executor) throws IOException {</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
</pre><td class="rouge-code"><pre>synchronized (lock) {
    checkState(!isDisposed(), "checkpoint is discarded");
    checkState(
        isFullyAcknowledged(),
        "Pending checkpoint has not been fully acknowledged yet");

    // make sure we fulfill the promise with an exception if something fails
    try {
        //填充operatorStates
        checkpointPlan.fulfillFinishedTaskStatus(operatorStates);
        //元数据信息
        // write out the metadata
        final CheckpointMetadata savepoint =
        new CheckpointMetadata(checkpointId, operatorStates.values(), masterStates);
        final CompletedCheckpointStorageLocation finalizedLocation;
        //持久化到文件,注意返回位置信息finalizedLocation
        try (CheckpointMetadataOutputStream out =
             targetLocation.createMetadataOutputStream()) {
            Checkpoints.storeCheckpointMetadata(savepoint, out);
            finalizedLocation = out.closeAndFinalizeCheckpoint();
        }
        //包括ckp元数据信息位置finalizedLocation，统计信息stats
        CompletedCheckpoint completed =
        new CompletedCheckpoint(
            jobId,
            checkpointId,
            checkpointTimestamp,
            System.currentTimeMillis(),
            operatorStates,
            masterStates,
            props,
            finalizedLocation,
            toCompletedCheckpointStats(finalizedLocation));

        onCompletionPromise.complete(completed);

        // mark this pending checkpoint as disposed, but do NOT drop the state
        dispose(false, checkpointsCleaner, postCleanup, executor);

        return completed;
    } catch (Throwable t) {
        onCompletionPromise.completeExceptionally(t);
        ExceptionUtils.rethrowIOException(t);
        return null; // silence the compiler
    }
} } ``` addCompletedCheckpointToStoreAndSubsumeOldest 更新completedCheckpointStore&lt;br /&gt;completedCheckpointStore的默认实现DefaultCompletedCheckpointStore，存储到zk&lt;br /&gt;还有一个是StandaloneCompletedCheckpointStore，主要是JM的内存 ``` private CompletedCheckpoint addCompletedCheckpointToStoreAndSubsumeOldest(
long checkpointId,
CompletedCheckpoint completedCheckpoint,
List&lt;ExecutionVertex&gt; tasksToAbort) throws CheckpointException {
try {
    final CompletedCheckpoint subsumedCheckpoint =
    completedCheckpointStore.addCheckpointAndSubsumeOldestOne(
        completedCheckpoint, checkpointsCleaner, this::scheduleTriggerRequest);
    // reset the force full snapshot flag, we should've completed at least one full
    // snapshot by now
    this.forceFullSnapshot = false;
    return subsumedCheckpoint;
} catch (Exception exception) {
    if (exception instanceof PossibleInconsistentStateException) {
        LOG.warn(
            "An error occurred while writing checkpoint {} to the underlying metadata"
            + " store. Flink was not able to determine whether the metadata was"
            + " successfully persisted. The corresponding state located at '{}'"
            + " won't be discarded and needs to be cleaned up manually.",
            completedCheckpoint.getCheckpointID(),
            completedCheckpoint.getExternalPointer());
    } else {
        // we failed to store the completed checkpoint. Let's clean up
        checkpointsCleaner.cleanCheckpointOnFailedStoring(completedCheckpoint, executor);
    }

    reportFailedCheckpoint(checkpointId, exception);
    sendAbortedMessages(tasksToAbort, checkpointId, completedCheckpoint.getTimestamp());
    throw new CheckpointException(
        "Could not complete the pending checkpoint " + checkpointId + '.',
        CheckpointFailureReason.FINALIZE_CHECKPOINT_FAILURE,
        exception);
} } ``` HA支持zookeeper或者k8s,对应两种实现ZooKeeperStateHandleStore或者KubernetesStateHandleStore ``` //DefaultCompletedCheckpointStore public CompletedCheckpoint addCheckpointAndSubsumeOldestOne(
final CompletedCheckpoint checkpoint,
CheckpointsCleaner checkpointsCleaner,
Runnable postCleanup) throws Exception {
Preconditions.checkState(running.get(), "Checkpoint store has already been shutdown.");
checkNotNull(checkpoint, "Checkpoint");

final String path =
completedCheckpointStoreUtil.checkpointIDToName(checkpoint.getCheckpointID());
//HA支持zookeeper或者k8s,对应两种实现ZooKeeperStateHandleStore或者KubernetesStateHandleStore
// Now add the new one. If it fails, we don't want to lose existing data.
checkpointStateHandleStore.addAndLock(path, checkpoint);

completedCheckpoints.addLast(checkpoint);

Optional&lt;CompletedCheckpoint&gt; subsume =
CheckpointSubsumeHelper.subsume(
    completedCheckpoints,
    maxNumberOfCheckpointsToRetain,
    completedCheckpoint -&gt;
    tryRemoveCompletedCheckpoint(
        completedCheckpoint,
        completedCheckpoint.shouldBeDiscardedOnSubsume(),
        checkpointsCleaner,
        postCleanup));
unregisterUnusedState(completedCheckpoints);

if (subsume.isPresent()) {
    LOG.debug("Added {} to {} without any older checkpoint to subsume.", checkpoint, path);
} else {
    LOG.debug("Added {} to {} and subsume {}.", checkpoint, path, subsume);
}
return subsume.orElse(null); } ``` ZooKeeperStateHandleStore ``` public RetrievableStateHandle&lt;T&gt; addAndLock(String pathInZooKeeper, T state) throws PossibleInconsistentStateException, Exception {
checkNotNull(pathInZooKeeper, "Path in ZooKeeper");
checkNotNull(state, "State");
final String path = normalizePath(pathInZooKeeper);
final Optional&lt;Stat&gt; maybeStat = getStat(path);

if (maybeStat.isPresent()) {
    if (isNotMarkedForDeletion(maybeStat.get())) {
        throw new AlreadyExistException(
            String.format("ZooKeeper node %s already exists.", path));
    }

    Preconditions.checkState(
        releaseAndTryRemove(path),
        "The state is marked for deletion and, therefore, should be deletable.");
}
这里store是FileSystemStateStorageHelper
final RetrievableStateHandle&lt;T&gt; storeHandle = storage.store(state);
final byte[] serializedStoreHandle = serializeOrDiscard(storeHandle);
try {
    writeStoreHandleTransactionally(path, serializedStoreHandle);
    return storeHandle;
} catch (KeeperException.NodeExistsException e) {
    // Transactions are not idempotent in the curator version we're currently using, so it
    // is actually possible that we've re-tried a transaction that has already succeeded.
    // We've ensured that the node hasn't been present prior executing the transaction, so
    // we can assume that this is a result of the retry mechanism.
    return storeHandle;
} catch (Exception e) {
    if (indicatesPossiblyInconsistentState(e)) {
        throw new PossibleInconsistentStateException(e);
    }
    // In case of any other failure, discard the state and rethrow the exception.
    storeHandle.discardState();
    throw e;
} } ``` FileSystemStateStorageHelper ``` public RetrievableStateHandle&lt;T&gt; store(T state) throws Exception {
Exception latestException = null;

for (int attempt = 0; attempt &lt; 10; attempt++) {
    Path filePath = getNewFilePath();
    //写文件
    try (FSDataOutputStream outStream =
         fs.create(filePath, FileSystem.WriteMode.NO_OVERWRITE)) {
        InstantiationUtil.serializeObject(outStream, state);
        return new RetrievableStreamStateHandle&lt;T&gt;(filePath, outStream.getPos());
    } catch (Exception e) {
        latestException = e;
    }
}

throw new Exception("Could not open output stream for state backend", latestException); } ``` 恢复 ``` //创建 completedCheckpointStore this.completedCheckpointStore = SchedulerUtils.createCompletedCheckpointStoreIfCheckpointingIsEnabled(
jobGraph,
jobMasterConfiguration,
checkNotNull(checkpointRecoveryFactory),
ioExecutor,
log); //创建与 this.executionGraph = createAndRestoreExecutionGraph(
completedCheckpointStore,
checkpointsCleaner,
checkpointIdCounter,
initializationTimestamp,
mainThreadExecutor,
jobStatusListener,
vertexParallelismStore); ``` DefaultExecutionGraphFactory&lt;br /&gt;如果checkpointCoordinator存在则尝试从Checkpoint恢复&lt;br /&gt;如果ckp没有，则尝试从savepoint恢复 ``` public ExecutionGraph createAndRestoreExecutionGraph(
JobGraph jobGraph,
CompletedCheckpointStore completedCheckpointStore,
CheckpointsCleaner checkpointsCleaner,
CheckpointIDCounter checkpointIdCounter,
TaskDeploymentDescriptorFactory.PartitionLocationConstraint partitionLocationConstraint,
long initializationTimestamp,
VertexAttemptNumberStore vertexAttemptNumberStore,
VertexParallelismStore vertexParallelismStore,
ExecutionStateUpdateListener executionStateUpdateListener,
Logger log) throws Exception {
ExecutionDeploymentListener executionDeploymentListener =
new ExecutionDeploymentTrackerDeploymentListenerAdapter(executionDeploymentTracker);
ExecutionStateUpdateListener combinedExecutionStateUpdateListener =
(execution, previousState, newState) -&gt; {
    executionStateUpdateListener.onStateUpdate(execution, previousState, newState);
    if (newState.isTerminal()) {
        executionDeploymentTracker.stopTrackingDeploymentOf(execution);
    }
};

final ExecutionGraph newExecutionGraph =
DefaultExecutionGraphBuilder.buildGraph(
    jobGraph,
    configuration,
    futureExecutor,
    ioExecutor,
    userCodeClassLoader,
    completedCheckpointStore,
    checkpointsCleaner,
    checkpointIdCounter,
    rpcTimeout,
    blobWriter,
    log,
    shuffleMaster,
    jobMasterPartitionTracker,
    partitionLocationConstraint,
    executionDeploymentListener,
    combinedExecutionStateUpdateListener,
    initializationTimestamp,
    vertexAttemptNumberStore,
    vertexParallelismStore,
    checkpointStatsTrackerFactory,
    isDynamicGraph);

final CheckpointCoordinator checkpointCoordinator =
newExecutionGraph.getCheckpointCoordinator();
//如果checkpointCoordinator存在则尝试从Checkpoint恢复
if (checkpointCoordinator != null) {
    // check whether we find a valid checkpoint
    if (!checkpointCoordinator.restoreInitialCheckpointIfPresent(
        new HashSet&lt;&gt;(newExecutionGraph.getAllVertices().values()))) {

        // check whether we can restore from a savepoint
        tryRestoreExecutionGraphFromSavepoint(
            newExecutionGraph, jobGraph.getSavepointRestoreSettings());
    }
}

return newExecutionGraph; } ```
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/flink1-15/'>Flink1.15</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/flink/" class="post-tag no-text-decoration" >flink</a> <a href="/tags/realtime/" class="post-tag no-text-decoration" >realtime</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Flink1.15+CheckPoint+restore%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90+-+2pc&url=%2Fposts%2Fckp_restore%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Flink1.15+CheckPoint+restore%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90+-+2pc&u=%2Fposts%2Fckp_restore%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fckp_restore%2F&text=Flink1.15+CheckPoint+restore%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90+-+2pc" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dubbo_threadpool/">Dubbo线程池问题汇总</a><li><a href="/posts/rocketMQ_max_maxReconsumeTimes/">RocketMQ 最大消费次数maxReconsumeTimes</a><li><a href="/posts/CF_forkjoin/">CompletableFuture与ForkJoinPool</a><li><a href="/posts/Elasticsearch-notes/">Elasticsearch笔记</a><li><a href="/posts/Solr5/">Solr5.x &&SolrCloud</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/realtime/">realtime</a> <a class="post-tag" href="/tags/flink/">flink</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/datascience/">Datascience</a> <a class="post-tag" href="/tags/ml/">ML</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/streamsets/">streamsets</a> <a class="post-tag" href="/tags/search/">Search</a> <a class="post-tag" href="/tags/file/">File</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/flink_svg/"><div class="card-body"> <em class="small" data-ts="1663545600" data-df="ll" > Sep 19, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Flink流程图整理以及画图模板</h3><div class="text-muted small"><p> [drawio项目文件地址]（https://github.com/2pc/mydrawio） Checkpoint流程 启动流程 FlinkSQL Flink Slot管理 画图模板 画图模板PNG</p></div></div></a></div><div class="card"> <a href="/posts/flink_on_yarn/"><div class="card-body"> <em class="small" data-ts="1540252800" data-df="ll" > Oct 23, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Flink On Yarn</h3><div class="text-muted small"><p> 配置环境变量HADOOP_CONF_DIR,将yarn的配置文件解压在此目录 export HADOOP_CONF_DIR=/opt/soft/yarn-conf start yarn-session ./yarn-session.sh -n 8 -s 8 -jm 1024 -tm 1024 -nm flink –d Submit a job to YARN wget -O LI...</p></div></div></a></div><div class="card"> <a href="/posts/flink_jm_tm_start/"><div class="card-body"> <em class="small" data-ts="1542844800" data-df="ll" > Nov 22, 2018 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Flink jobmanager&taskmanager的启动</h3><div class="text-muted small"><p> YarnApplicationMasterRunner–&amp;gt;run()–&amp;gt;runApplicationMaster() // 2: the JobManager LOG.debug(&quot;Starting JobManager actor&quot;); // we start the JobManager with its standard name ActorRef jobManager ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ckp/" class="btn btn-outline-primary" prompt="Older"><p>Flink1.15 CheckPoint源码分析</p></a> <a href="/posts/InputData&OutputData/" class="btn btn-outline-primary" prompt="Newer"><p>Flink1.15 CKP InputData&OutPutData源码分析</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/2pc">2pc</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/realtime/">realtime</a> <a class="post-tag" href="/tags/flink/">flink</a> <a class="post-tag" href="/tags/distributed/">distributed</a> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/datascience/">Datascience</a> <a class="post-tag" href="/tags/ml/">ML</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/streamsets/">streamsets</a> <a class="post-tag" href="/tags/search/">Search</a> <a class="post-tag" href="/tags/file/">File</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
